# Usamos una imagen oficial de PHP 8.4 que ya incluye Apache.
FROM php:8.4-apache

# 1. Instalar dependencias del sistema y extensiones de PHP
#    - Se limpian los cachés de apt al final para reducir el tamaño de la imagen.
RUN apt-get update && apt-get install -y \
    libxslt-dev \
    libsqlite3-dev \
    libzip-dev \
    --no-install-recommends \
    && rm -rf /var/lib/apt/lists/*

# Instala las extensiones de PHP que necesitamos
RUN docker-php-ext-install pdo_sqlite xsl zip

# 2. Habilitar mod_rewrite de Apache para URLs amigables
RUN a2enmod rewrite

# 3. Copiar nuestra configuración de VirtualHost personalizada
COPY docker/apache-vhost-prod.conf /etc/apache2/sites-available/000-default.conf

# 4. Establecer el directorio de trabajo
WORKDIR /var/www/html

# 5. Copiar el código de la aplicación a la imagen
#    - Esto respeta tu archivo .dockerignore, así que no se copiarán
#      archivos de desarrollo, tests, git, etc.
COPY . .

# 6. [BUENA PRÁCTICA] Ajustar permisos
#    - El servidor Apache se ejecuta como el usuario `www-data`.
#    - Nos aseguramos de que este usuario sea el propietario de los archivos
#      para evitar cualquier problema de permisos.
RUN chown -R www-data:www-data /var/www/html

# 7. Exponer el puerto. Esto es más bien informativo, pero es una buena práctica.
EXPOSE 80